<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIタスク司令塔</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --bg: #0F172A; --card: #1E293B; --accent: #6366F1; }
    body { background: var(--bg); color: #e2e8f0; font-family: system-ui, -apple-system, sans-serif; }
    .card { background: var(--card); }
    .dark-input {
      background: #0F172A;
      border: 1px solid #334155;
      color: #e2e8f0;
      transition: border-color 0.15s;
    }
    .dark-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(99,102,241,0.15); }
    .dark-input::placeholder { color: #475569; }
    .skeleton { background: linear-gradient(90deg, #1E293B 25%, #2d3f55 50%, #1E293B 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .btn-primary { background: var(--accent); color: white; transition: background 0.15s; }
    .btn-primary:hover { background: #4f46e5; }
    .btn-primary:disabled { background: #334155; color: #64748b; cursor: not-allowed; }
    .toast-item { animation: slideIn 0.2s ease; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    textarea { resize: vertical; }
    .buf-btn { transition: all 0.15s; }
    .buf-btn.active { background: rgba(99,102,241,0.3); border-color: rgba(99,102,241,0.6); color: #a5b4fc; }
    .section-box { border-left: 3px solid; }
    .copy-btn:active { transform: scale(0.95); }
  </style>
</head>
<body class="min-h-screen">

<!-- Toast container -->
<div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2 pointer-events-none"></div>

<!-- API Key Modal -->
<div id="modal-overlay" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-40 hidden">
  <div class="card rounded-2xl p-6 w-full max-w-md mx-4 border border-slate-700">
    <h2 class="text-base font-bold mb-1">APIキーを設定</h2>
    <p class="text-xs text-slate-400 mb-3 leading-relaxed">
      使用するAIプロバイダーとAPIキーを入力してください。<br>
      キーはサーバーメモリのみに保持され、永続化・ログ出力は行いません。
    </p>
    <div class="flex gap-4 mb-3">
      <label class="flex items-center gap-1.5 text-sm cursor-pointer">
        <input type="radio" name="modal-provider" value="anthropic" checked
               onchange="onProviderChange('anthropic')" class="accent-indigo-500">
        Claude (Anthropic)
      </label>
      <label class="flex items-center gap-1.5 text-sm cursor-pointer">
        <input type="radio" name="modal-provider" value="gemini"
               onchange="onProviderChange('gemini')" class="accent-indigo-500">
        Gemini (Google)
      </label>
    </div>
    <input
      type="password"
      id="api-key-input"
      placeholder="sk-ant-api03-..."
      class="dark-input w-full px-3 py-2 rounded-lg text-sm mb-4 font-mono"
    >
    <div class="flex gap-2 justify-end">
      <button id="api-key-cancel" class="text-sm px-4 py-2 rounded-lg text-slate-400 hover:text-white transition-colors">
        キャンセル
      </button>
      <button id="api-key-submit" class="btn-primary text-sm px-5 py-2 rounded-lg font-semibold">
        設定する
      </button>
    </div>
  </div>
</div>

<!-- Header -->
<header class="border-b border-slate-800 px-4 py-3 flex items-center gap-3 flex-wrap">
  <div class="flex items-center gap-2 mr-auto">
    <span class="text-lg font-bold tracking-tight">AIタスク司令塔</span>
    <span class="text-xs text-slate-600 hidden sm:block">Slackの依頼をAIがタスク分解</span>
  </div>

  <!-- PROJECT.md context -->
  <div class="flex items-center gap-1">
    <label class="cursor-pointer">
      <span id="context-badge" class="text-xs px-3 py-1 rounded-full border border-slate-700 text-slate-500 hover:border-slate-500 transition-colors cursor-pointer select-none">
        コンテキスト未設定
      </span>
      <input type="file" id="context-file-input" accept=".md,.txt" class="hidden">
    </label>
    <button id="context-remove-btn" class="hidden text-xs text-slate-600 hover:text-red-400 transition-colors px-1" title="削除">✕</button>
  </div>

  <!-- API key status -->
  <div class="flex items-center gap-2">
    <span id="api-key-dot" class="w-2 h-2 rounded-full bg-red-500 flex-none"></span>
    <button id="api-key-btn" class="text-xs px-3 py-1 rounded-full border border-slate-700 text-slate-400 hover:border-indigo-500 hover:text-indigo-400 transition-colors">
      APIキー設定
    </button>
  </div>

  <!-- Clear -->
  <button id="clear-btn" class="text-xs px-3 py-1 rounded-full border border-slate-700 text-slate-500 hover:border-red-500 hover:text-red-400 transition-colors">
    全クリア
  </button>
</header>

<!-- Main -->
<main class="px-4 py-4 max-w-3xl mx-auto">

  <!-- Input Panel -->
  <div class="card rounded-2xl p-4 mb-5 border border-slate-700/50">
    <textarea
      id="message-input"
      rows="4"
      placeholder="Slackのメッセージをコピペ…&#10;例：「認証周りのバグ直してほしい。本番で出てるやつ」&#10;例：「来週までにダッシュボードのAPIをv2に移行したい」&#10;例：「サーバーのメモリ使用率が高騰してるので調査して」"
      class="dark-input w-full px-3 py-2 rounded-lg text-sm leading-relaxed"
    ></textarea>

    <!-- Buffer selection -->
    <div class="flex items-center gap-2 mt-3 flex-wrap">
      <span class="text-xs text-slate-500 flex-none">バッファ:</span>
      <button onclick="selectBuffer(null)"     class="buf-btn active text-xs px-2.5 py-1 rounded-lg border border-slate-700 text-slate-400">なし</button>
      <button onclick="selectBuffer({hours:2})"  class="buf-btn text-xs px-2.5 py-1 rounded-lg border border-slate-700 text-slate-400">+2h</button>
      <button onclick="selectBuffer({hours:4})"  class="buf-btn text-xs px-2.5 py-1 rounded-lg border border-slate-700 text-slate-400">+4h</button>
      <button onclick="selectBuffer({multiplier:1.5})" class="buf-btn text-xs px-2.5 py-1 rounded-lg border border-slate-700 text-slate-400">×1.5</button>
      <div class="flex items-center gap-1">
        <input type="number" id="custom-buffer" min="0" step="0.5" placeholder="カスタム"
               oninput="onCustomBuffer()"
               class="dark-input text-xs px-2 py-1 rounded-lg w-20 font-mono">
        <span class="text-xs text-slate-600">h</span>
      </div>
    </div>

    <div class="flex justify-between items-center mt-3">
      <span id="char-count" class="text-xs text-slate-600">0 / 500文字</span>
      <div class="flex items-center gap-3">
        <span class="text-xs text-slate-700">Cmd+Enter で送信</span>
        <button id="analyze-btn" class="btn-primary flex-none px-5 py-2 rounded-xl font-semibold text-sm whitespace-nowrap">
          AI分解する
        </button>
      </div>
    </div>
  </div>

  <!-- Skeleton loader -->
  <div id="skeleton-loader" class="hidden mb-5">
    <p class="text-xs text-slate-500 text-center mb-3 animate-pulse">AIが分析中...</p>
    <div class="skeleton rounded-2xl h-64 w-full"></div>
  </div>

  <!-- Empty state -->
  <div id="empty-state" class="text-center py-24 text-slate-700">
    <p class="text-sm">依頼メッセージを入力して「AI分解する」を押してみましょう</p>
  </div>

  <!-- Results area -->
  <div id="results-area" class="hidden space-y-4"></div>

</main>

<script>
// ============================================================
// State
// ============================================================
const state = {
  tasks: [],
  hasApiKey: false,
  provider: 'anthropic',
  hasContext: false,
  contextFilename: null,
  loading: false,
  buffer: null,  // { hours: N } or { multiplier: N } or null
};

// ============================================================
// API helper
// ============================================================
async function api(method, path, body) {
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (body !== undefined) opts.body = JSON.stringify(body);
  const res = await fetch(path, opts);
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
  return data;
}

// ============================================================
// Init
// ============================================================
async function init() {
  try {
    const [tasks, keyStatus, ctxStatus] = await Promise.all([
      api('GET', '/api/tasks'),
      api('GET', '/api/has-key'),
      api('GET', '/api/context'),
    ]);
    state.tasks = tasks;
    state.hasApiKey = keyStatus.hasKey;
    state.provider = keyStatus.provider || 'anthropic';
    state.hasContext = ctxStatus.hasContext;
    state.contextFilename = ctxStatus.filename;

    updateApiKeyUI();
    updateContextBadge();
    renderResults();

    if (!state.hasApiKey) openModal();
  } catch (e) {
    toast('初期化エラー: ' + e.message, 'error');
  }
}

// ============================================================
// Buffer selection
// ============================================================
function selectBuffer(buf) {
  state.buffer = buf;
  document.getElementById('custom-buffer').value = '';
  updateBufferButtons();
}

function onCustomBuffer() {
  const val = parseFloat(document.getElementById('custom-buffer').value);
  if (val > 0) {
    state.buffer = { hours: val };
  } else {
    state.buffer = null;
  }
  updateBufferButtons();
}

function updateBufferButtons() {
  const btns = document.querySelectorAll('.buf-btn');
  btns.forEach(btn => btn.classList.remove('active'));

  if (!state.buffer) {
    btns[0].classList.add('active');
  } else if (state.buffer.hours === 2) {
    btns[1].classList.add('active');
  } else if (state.buffer.hours === 4) {
    btns[2].classList.add('active');
  } else if (state.buffer.multiplier === 1.5) {
    btns[3].classList.add('active');
  }
  // custom input → no preset button active
}

// ============================================================
// Render results
// ============================================================
function renderResults() {
  const area = document.getElementById('results-area');
  const hasTasks = state.tasks.length > 0;

  document.getElementById('empty-state').classList.toggle('hidden', hasTasks || state.loading);
  area.classList.toggle('hidden', !hasTasks);

  if (!hasTasks) { area.innerHTML = ''; return; }

  // Render newest first
  const sorted = [...state.tasks].reverse();
  area.innerHTML = sorted.map(renderTask).join('');
}

function renderTask(task) {
  const stepsHtml = (task.steps || []).map(s => `
    <li class="flex items-center gap-3 py-1.5 text-sm text-slate-300">
      <span class="text-xs font-mono text-slate-600 flex-none w-5 text-right">${s.order}.</span>
      <span class="flex-1">${esc(s.title)}</span>
      <span class="font-mono text-xs text-slate-500 flex-none">${s.hours}h</span>
    </li>
  `).join('');

  const backlog = task.backlog || {};
  const backlogText = `## 背景\n${backlog.background || ''}\n\n## 目的\n${backlog.purpose || ''}\n\n## 期待動作\n${backlog.expectedBehavior || ''}`;

  const bufferLabel = task.buffer
    ? (task.buffer.multiplier ? `×${task.buffer.multiplier}` : `+${task.buffer.hours}h`)
    : '';

  return `
<div class="card rounded-2xl border border-slate-700/40 overflow-hidden" data-id="${task.id}">

  <!-- Header -->
  <div class="px-5 py-4 border-b border-slate-700/40 flex items-center justify-between">
    <h2 class="font-semibold text-base">${esc(task.title)}</h2>
    <div class="flex items-center gap-2">
      ${bufferLabel ? `<span class="text-xs px-2 py-0.5 rounded-full border border-orange-500/30 text-orange-400 bg-orange-500/10">バッファ ${bufferLabel}</span>` : ''}
      <span class="text-lg font-mono font-bold text-indigo-400">${task.totalHours}h</span>
      <span class="text-xs text-slate-500">(${task.estimatedDays}日)</span>
    </div>
  </div>

  <!-- Steps -->
  <div class="px-5 py-4 border-b border-slate-700/40">
    <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">作業手順</h3>
    <ol class="space-y-0.5">
      ${stepsHtml}
    </ol>
  </div>

  <!-- Backlog ticket -->
  <div class="px-5 py-4 border-b border-slate-700/40">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Backlogチケット</h3>
      <button onclick="copyText(\`${esc(backlogText).replace(/`/g, '\\`')}\`)" class="copy-btn text-xs text-indigo-400 hover:text-indigo-300 transition-colors">コピー</button>
    </div>
    <div class="text-sm leading-relaxed space-y-3 p-3 rounded-lg border border-slate-700/50" style="background:#0F172A">
      <div>
        <div class="font-semibold text-slate-300 mb-1">## 背景</div>
        <div class="text-slate-400">${esc(backlog.background || '')}</div>
      </div>
      <div>
        <div class="font-semibold text-slate-300 mb-1">## 目的</div>
        <div class="text-slate-400">${esc(backlog.purpose || '')}</div>
      </div>
      <div>
        <div class="font-semibold text-slate-300 mb-1">## 期待動作</div>
        <div class="text-slate-400 whitespace-pre-wrap">${esc(backlog.expectedBehavior || '')}</div>
      </div>
    </div>
  </div>

  <!-- Slack reply -->
  <div class="px-5 py-4">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Slack返信</h3>
      <button onclick="copyEl('sr-${task.id}')" class="copy-btn text-xs text-indigo-400 hover:text-indigo-300 transition-colors">コピー</button>
    </div>
    <pre id="sr-${task.id}" class="text-sm rounded-lg p-3 whitespace-pre-wrap text-slate-300 leading-relaxed border border-slate-700/50 select-all" style="background:#0F172A">${esc(task.slackReply || '')}</pre>
  </div>

</div>`;
}

// ============================================================
// Analyze
// ============================================================
async function analyzeTask() {
  const msg = document.getElementById('message-input').value.trim();
  if (!msg) { toast('メッセージを入力してください', 'error'); return; }
  if (msg.length < 5) { toast('メッセージが短すぎます（5文字以上）', 'error'); return; }
  if (!state.hasApiKey) { openModal(); return; }

  state.loading = true;
  const analyzeBtn = document.getElementById('analyze-btn');
  analyzeBtn.disabled = true;
  document.getElementById('skeleton-loader').classList.remove('hidden');
  document.getElementById('empty-state').classList.add('hidden');

  try {
    const body = { message: msg };
    if (state.buffer) body.buffer = state.buffer;

    await api('POST', '/api/analyze', body);
    state.tasks = await api('GET', '/api/tasks');
    document.getElementById('message-input').value = '';
    document.getElementById('char-count').textContent = '0 / 500文字';
    renderResults();
    toast('タスクを生成しました', 'success');
  } catch (e) {
    toast('エラー: ' + e.message, 'error');
  } finally {
    state.loading = false;
    analyzeBtn.disabled = false;
    document.getElementById('skeleton-loader').classList.add('hidden');
    if (!state.tasks.length) {
      document.getElementById('empty-state').classList.remove('hidden');
    }
  }
}

// ============================================================
// API Key modal
// ============================================================
const PROVIDER_PLACEHOLDERS = {
  anthropic: 'sk-ant-api03-...',
  gemini: 'AIzaSy...',
};

function onProviderChange(provider) {
  document.getElementById('api-key-input').placeholder = PROVIDER_PLACEHOLDERS[provider] || '';
}

function openModal() {
  const radios = document.querySelectorAll('input[name="modal-provider"]');
  radios.forEach(r => { r.checked = r.value === state.provider; });
  document.getElementById('api-key-input').placeholder = PROVIDER_PLACEHOLDERS[state.provider] || '';
  document.getElementById('modal-overlay').classList.remove('hidden');
  setTimeout(() => document.getElementById('api-key-input').focus(), 50);
}
function closeModal() {
  document.getElementById('modal-overlay').classList.add('hidden');
}
async function submitApiKey() {
  const key = document.getElementById('api-key-input').value.trim();
  if (!key) { toast('APIキーを入力してください', 'error'); return; }
  const provider = document.querySelector('input[name="modal-provider"]:checked')?.value || 'anthropic';
  try {
    await api('POST', '/api/set-key', { apiKey: key, provider });
    state.hasApiKey = true;
    state.provider = provider;
    updateApiKeyUI();
    closeModal();
    const name = provider === 'gemini' ? 'Gemini' : 'Claude';
    toast(`${name} APIキーを設定しました`, 'success');
  } catch (e) {
    toast('設定エラー: ' + e.message, 'error');
  }
}
function updateApiKeyUI() {
  const dot = document.getElementById('api-key-dot');
  dot.className = `w-2 h-2 rounded-full flex-none ${state.hasApiKey ? 'bg-green-400' : 'bg-red-500'}`;
  const btn = document.getElementById('api-key-btn');
  if (state.hasApiKey) {
    const name = state.provider === 'gemini' ? 'Gemini' : 'Claude';
    btn.textContent = `${name} キー設定済`;
  } else {
    btn.textContent = 'APIキー設定';
  }
}

// ============================================================
// Context (PROJECT.md)
// ============================================================
async function uploadContext(file) {
  if (!file) return;
  const fd = new FormData();
  fd.append('file', file);
  try {
    const res = await fetch('/api/upload-context', { method: 'POST', body: fd });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error);
    state.hasContext = true;
    state.contextFilename = data.filename;
    updateContextBadge();
    toast(`${data.filename} を読み込みました`, 'success');
  } catch (e) {
    toast('コンテキスト読み込みエラー: ' + e.message, 'error');
  }
}
async function removeContext() {
  try {
    await api('DELETE', '/api/context');
    state.hasContext = false;
    state.contextFilename = null;
    updateContextBadge();
    toast('コンテキストを削除しました', 'success');
  } catch (e) {
    toast(e.message, 'error');
  }
}
function updateContextBadge() {
  const badge     = document.getElementById('context-badge');
  const removeBtn = document.getElementById('context-remove-btn');
  if (state.hasContext) {
    const name = state.contextFilename || 'コンテキスト適用中';
    badge.textContent = name;
    badge.className = 'text-xs px-3 py-1 rounded-full border border-green-600/50 text-green-400 bg-green-500/10 cursor-pointer select-none';
    removeBtn.classList.remove('hidden');
  } else {
    badge.textContent = 'コンテキスト未設定';
    badge.className = 'text-xs px-3 py-1 rounded-full border border-slate-700 text-slate-500 hover:border-slate-500 transition-colors cursor-pointer select-none';
    removeBtn.classList.add('hidden');
  }
}

// ============================================================
// Utils
// ============================================================
function copyEl(id) {
  const el = document.getElementById(id);
  if (!el) return;
  navigator.clipboard.writeText(el.textContent).then(() => {
    toast('コピーしました', 'success');
  }).catch(() => {
    toast('コピーに失敗しました', 'error');
  });
}

function copyText(text) {
  navigator.clipboard.writeText(text).then(() => {
    toast('コピーしました', 'success');
  }).catch(() => {
    toast('コピーに失敗しました', 'error');
  });
}

function esc(str) {
  return String(str || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

function toast(msg, type = 'info') {
  const colors = {
    success: 'bg-green-500/20 border-green-500/40 text-green-300',
    error:   'bg-red-500/20 border-red-500/40 text-red-300',
    info:    'bg-indigo-500/20 border-indigo-500/40 text-indigo-300',
  };
  const el = document.createElement('div');
  el.className = `toast-item pointer-events-auto px-4 py-2 rounded-xl border text-sm max-w-xs ${colors[type] || colors.info}`;
  el.style.background = '#1E293B';
  el.textContent = msg;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => el.remove(), 3500);
}

// ============================================================
// Event Listeners
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
  init();

  // Analyze
  document.getElementById('analyze-btn').addEventListener('click', analyzeTask);
  document.getElementById('message-input').addEventListener('keydown', e => {
    if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) analyzeTask();
  });
  document.getElementById('message-input').addEventListener('input', e => {
    const len = e.target.value.length;
    const el  = document.getElementById('char-count');
    el.textContent = `${len} / 500文字`;
    el.className   = `text-xs ${len > 500 ? 'text-red-400' : 'text-slate-600'}`;
  });

  // API key modal
  document.getElementById('api-key-btn').addEventListener('click', openModal);
  document.getElementById('api-key-cancel').addEventListener('click', closeModal);
  document.getElementById('api-key-submit').addEventListener('click', submitApiKey);
  document.getElementById('api-key-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') submitApiKey();
    if (e.key === 'Escape') closeModal();
  });
  document.getElementById('modal-overlay').addEventListener('click', e => {
    if (e.target === e.currentTarget) closeModal();
  });

  // Context file
  document.getElementById('context-file-input').addEventListener('change', e => {
    if (e.target.files[0]) uploadContext(e.target.files[0]);
    e.target.value = '';
  });
  document.getElementById('context-remove-btn').addEventListener('click', removeContext);

  // Clear all
  document.getElementById('clear-btn').addEventListener('click', async () => {
    if (!confirm('全タスクを削除しますか？')) return;
    try {
      await api('DELETE', '/api/tasks/clear');
      state.tasks = [];
      renderResults();
      toast('タスクをクリアしました', 'success');
    } catch (e) {
      toast(e.message, 'error');
    }
  });

  // Drag & drop PROJECT.md
  document.addEventListener('dragover', e => e.preventDefault());
  document.addEventListener('drop', e => {
    e.preventDefault();
    const file = e.dataTransfer.files[0];
    if (file && (file.name.endsWith('.md') || file.name.endsWith('.txt'))) {
      uploadContext(file);
    }
  });
});
</script>
</body>
</html>
